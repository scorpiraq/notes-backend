"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.attachMiddleware = exports.attachControllerInstances = exports.attachControllers = void 0;
const express_1 = require("express");
const di_1 = require("@decorators/di");
const meta_1 = require("./meta");
const middleware_1 = require("./middleware");
/**
 * Attach controllers to express application
 */
async function attachControllers(app, controllers) {
    const promises = controllers.map((controller) => registerController(app, controller, getController));
    await Promise.all(promises);
    // error middleware must be registered as the very last one
    app.use((0, middleware_1.errorMiddlewareHandler)());
}
exports.attachControllers = attachControllers;
/**
 * Attach controller instances to express application
 */
async function attachControllerInstances(app, controllers) {
    const promises = controllers.map((controller) => registerController(app, controller, (c) => c));
    await Promise.all(promises);
    // error middleware must be registered as the very last one
    app.use((0, middleware_1.errorMiddlewareHandler)());
}
exports.attachControllerInstances = attachControllerInstances;
/**
 * Register controller via registering new Router
 */
async function registerController(app, Controller, extractController) {
    const controller = await extractController(Controller);
    const meta = (0, meta_1.getMeta)(controller);
    const router = (0, express_1.Router)(meta.routerOptions);
    /**
     * Wrap all registered middleware with helper function
     * that can instantiate or get from the container instance of the class
     * or execute given middleware function
     */
    const routerMiddleware = (meta.middleware || [])
        .map(middleware => (0, middleware_1.middlewareHandler)(middleware));
    /**
     * Apply router middleware
     */
    if (routerMiddleware.length) {
        router.use(...routerMiddleware);
    }
    /**
     * Applying registered routes
     */
    for (const [methodName, methodMeta] of Object.entries(meta.routes)) {
        methodMeta.routes.forEach(route => {
            const routeMiddleware = (route.middleware || [])
                .map(middleware => (0, middleware_1.middlewareHandler)(middleware));
            const handler = routeHandler(controller, methodName, meta.params[methodName], methodMeta.status);
            router[route.method].apply(router, [
                route.url, ...routeMiddleware, handler,
            ]);
        });
    }
    app.use(meta.url, router);
    return app;
}
/**
 * Returns function that will call original route handler and wrap return options
 */
function routeHandler(controller, methodName, params, status) {
    return (req, res, next) => {
        const args = extractParameters(req, res, next, params);
        const result = controller[methodName].call(controller, ...args);
        if (result instanceof Promise) {
            result.then((r) => {
                if (!res.headersSent && typeof r !== 'undefined') {
                    if (status) {
                        res.status(status);
                    }
                    res.send(r);
                }
            }).catch(next);
        }
        else if (typeof result !== 'undefined') {
            if (!res.headersSent) {
                if (status) {
                    res.status(status);
                }
                res.send(result);
            }
        }
        return result;
    };
}
/**
 * Extract parameters for handlers
 */
function extractParameters(req, res, next, params = []) {
    const args = [];
    for (const { name, index, type } of params) {
        switch (type) {
            case meta_1.ParameterType.RESPONSE:
                args[index] = res;
                break;
            case meta_1.ParameterType.REQUEST:
                args[index] = getParam(req, null, name);
                break;
            case meta_1.ParameterType.NEXT:
                args[index] = next;
                break;
            case meta_1.ParameterType.PARAMS:
                args[index] = getParam(req, 'params', name);
                break;
            case meta_1.ParameterType.QUERY:
                args[index] = getParam(req, 'query', name);
                break;
            case meta_1.ParameterType.BODY:
                args[index] = getParam(req, 'body', name);
                break;
            case meta_1.ParameterType.HEADERS:
                args[index] = getParam(req, 'headers', name);
                break;
            case meta_1.ParameterType.COOKIES:
                args[index] = getParam(req, 'cookies', name);
                break;
        }
    }
    return args;
}
/**
 * Get controller instance from container or instantiate one
 */
function getController(Controller) {
    try {
        return di_1.Container.get(Controller);
    }
    catch (_a) {
        return new Controller();
    }
}
/**
 * Get parameter value from the source object
 */
function getParam(source, paramType, name) {
    const param = source[paramType] || source;
    return name ? param[name] : param;
}
/**
 * Attach middleware to controller metadata
 * @param {boolean} unshift if set to false all the custom decorator middlewares will be exectuted after the middlewares attached through controller
 *
 *
 * Note- Please use custom decorators before express method decorators Get Post etc.
 */
function attachMiddleware(target, property, middleware) {
    const meta = (0, meta_1.getMeta)(target);
    if (meta.url !== '') {
        meta.middleware.unshift(middleware);
    }
    else if (property in meta.routes) {
        meta.routes[property].routes[0].middleware.unshift(middleware);
    }
}
exports.attachMiddleware = attachMiddleware;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9leHByZXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHFDQUF3RztBQUN4Ryx1Q0FBMkM7QUFFM0MsaUNBQWtHO0FBQ2xHLDZDQUFrRztBQUVsRzs7R0FFRztBQUNJLEtBQUssVUFBVSxpQkFBaUIsQ0FBQyxHQUFxQixFQUFFLFdBQW1CO0lBQ2hGLE1BQU0sUUFBUSxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFnQixFQUFFLEVBQUUsQ0FDcEQsa0JBQWtCLENBQUMsR0FBRyxFQUFFLFVBQVUsRUFBRSxhQUFhLENBQUMsQ0FDbkQsQ0FBQztJQUVGLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUU1QiwyREFBMkQ7SUFDM0QsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFBLG1DQUFzQixHQUFFLENBQUMsQ0FBQztBQUNwQyxDQUFDO0FBVEQsOENBU0M7QUFFRDs7R0FFRztBQUNJLEtBQUssVUFBVSx5QkFBeUIsQ0FBQyxHQUFxQixFQUFFLFdBQWlDO0lBQ3RHLE1BQU0sUUFBUSxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFnQyxFQUFFLEVBQUUsQ0FDcEUsa0JBQWtCLENBQUMsR0FBRyxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQXFCLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUNsRSxDQUFDO0lBRUYsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRTVCLDJEQUEyRDtJQUMzRCxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUEsbUNBQXNCLEdBQUUsQ0FBQyxDQUFDO0FBQ3BDLENBQUM7QUFURCw4REFTQztBQUVEOztHQUVHO0FBQ0gsS0FBSyxVQUFVLGtCQUFrQixDQUMvQixHQUF5QixFQUN6QixVQUFxQyxFQUNyQyxpQkFBcUc7SUFFckcsTUFBTSxVQUFVLEdBQUcsTUFB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Q0FBQyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7S0FDaEU7QUFDSCxDQUFDO0FBUEQsNENBT0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0SGFuZGxlciwgQXBwbGljYXRpb24sIFJvdXRlciwgRXhwcmVzcywgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgQ29udGFpbmVyIH0gZnJvbSAnQGRlY29yYXRvcnMvZGknO1xuXG5pbXBvcnQgeyBnZXRNZXRhLCBQYXJhbWV0ZXJUeXBlLCBFeHByZXNzQ2xhc3MsIFBhcmFtZXRlckNvbmZpZ3VyYXRpb24sIEV4cHJlc3NNZXRhfSBmcm9tICcuL21ldGEnO1xuaW1wb3J0IHsgbWlkZGxld2FyZUhhbmRsZXIsIGVycm9yTWlkZGxld2FyZUhhbmRsZXIsIFR5cGUsIE1pZGRsZXdhcmVGdW5jdGlvbn0gZnJvbSAnLi9taWRkbGV3YXJlJztcblxuLyoqXG4gKiBBdHRhY2ggY29udHJvbGxlcnMgdG8gZXhwcmVzcyBhcHBsaWNhdGlvblxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYXR0YWNoQ29udHJvbGxlcnMoYXBwOiBFeHByZXNzIHwgUm91dGVyLCBjb250cm9sbGVyczogVHlwZVtdKSB7XG4gIGNvbnN0IHByb21pc2VzID0gY29udHJvbGxlcnMubWFwKChjb250cm9sbGVyOiBUeXBlKSA9PlxuICAgIHJlZ2lzdGVyQ29udHJvbGxlcihhcHAsIGNvbnRyb2xsZXIsIGdldENvbnRyb2xsZXIpLFxuICApO1xuXG4gIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcblxuICAvLyBlcnJvciBtaWRkbGV3YXJlIG11c3QgYmUgcmVnaXN0ZXJlZCBhcyB0aGUgdmVyeSBsYXN0IG9uZVxuICBhcHAudXNlKGVycm9yTWlkZGxld2FyZUhhbmRsZXIoKSk7XG59XG5cbi8qKlxuICogQXR0YWNoIGNvbnRyb2xsZXIgaW5zdGFuY2VzIHRvIGV4cHJlc3MgYXBwbGljYXRpb25cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGF0dGFjaENvbnRyb2xsZXJJbnN0YW5jZXMoYXBwOiBFeHByZXNzIHwgUm91dGVyLCBjb250cm9sbGVyczogSW5zdGFuY2VUeXBlPFR5cGU+W10pIHtcbiAgY29uc3QgcHJvbWlzZXMgPSBjb250cm9sbGVycy5tYXAoKGNvbnRyb2xsZXI6IEluc3RhbmNlVHlwZTxUeXBlPltdKSA9PlxuICAgIHJlZ2lzdGVyQ29udHJvbGxlcihhcHAsIGNvbnRyb2xsZXIsIChjOiBJbnN0YW5jZVR5cGU8VHlwZT4pID0+IGMpLFxuICApO1xuXG4gIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcblxuICAvLyBlcnJvciBtaWRkbGV3YXJlIG11c3QgYmUgcmVnaXN0ZXJlZCBhcyB0aGUgdmVyeSBsYXN0IG9uZVxuICBhcHAudXNlKGVycm9yTWlkZGxld2FyZUhhbmRsZXIoKSk7XG59XG5cbi8qKlxuICogUmVnaXN0ZXIgY29udHJvbGxlciB2aWEgcmVnaXN0ZXJpbmcgbmV3IFJvdXRlclxuICovXG5hc3luYyBmdW5jdGlvbiByZWdpc3RlckNvbnRyb2xsZXIoXG4gIGFwcDogQXBwbGljYXRpb24gfCBSb3V0ZXIsXG4gIENvbnRyb2xsZXI6IFR5cGUgfCBJbnN0YW5jZVR5cGU8VHlwZT4sXG4gIGV4dHJhY3RDb250cm9sbGVyOiAoYzogVHlwZSB8IEluc3RhbmNlVHlwZTxUeXBlPikgPT4gUHJvbWlzZTxJbnN0YW5jZVR5cGU8VHlwZT4+IHwgSW5zdGFuY2VUeXBlPFR5cGU+LFxuKSB7XG4gIGNvbnN0IGNvbnRyb2xsZXIgPSBhd2FpdCBleHRyYWN0Q29udHJvbGxlcihDb250cm9sbGVyKTtcbiAgY29uc3QgbWV0YSA9IGdldE1ldGEoY29udHJvbGxlcik7XG4gIGNvbnN0IHJvdXRlciA9IFJvdXRlcihtZXRhLnJvdXRlck9wdGlvbnMpO1xuXG4gIC8qKlxuICAgKiBXcmFwIGFsbCByZWdpc3RlcmVkIG1pZGRsZXdhcmUgd2l0aCBoZWxwZXIgZnVuY3Rpb25cbiAgICogdGhhdCBjYW4gaW5zdGFudGlhdGUgb3IgZ2V0IGZyb20gdGhlIGNvbnRhaW5lciBpbnN0YW5jZSBvZiB0aGUgY2xhc3NcbiAgICogb3IgZXhlY3V0ZSBnaXZlbiBtaWRkbGV3YXJlIGZ1bmN0aW9uXG4gICAqL1xuICBjb25zdCByb3V0ZXJNaWRkbGV3YXJlOiBSZXF1ZXN0SGFuZGxlcltdID0gKG1ldGEubWlkZGxld2FyZSB8fCBbXSlcbiAgICAubWFwKG1pZGRsZXdhcmUgPT4gbWlkZGxld2FyZUhhbmRsZXIobWlkZGxld2FyZSkpO1xuXG4gIC8qKlxuICAgKiBBcHBseSByb3V0ZXIgbWlkZGxld2FyZVxuICAgKi9cbiAgaWYgKHJvdXRlck1pZGRsZXdhcmUubGVuZ3RoKSB7XG4gICAgcm91dGVyLnVzZSguLi5yb3V0ZXJNaWRkbGV3YXJlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBseWluZyByZWdpc3RlcmVkIHJvdXRlc1xuICAgKi9cbiAgZm9yIChjb25zdCBbbWV0aG9kTmFtZSwgbWV0aG9kTWV0YV0gb2YgT2JqZWN0LmVudHJpZXMobWV0YS5yb3V0ZXMpKSB7XG4gICAgbWV0aG9kTWV0YS5yb3V0ZXMuZm9yRWFjaChyb3V0ZSA9PiB7XG4gICAgICBjb25zdCByb3V0ZU1pZGRsZXdhcmU6IFJlcXVlc3RIYW5kbGVyW10gPSAocm91dGUubWlkZGxld2FyZSB8fCBbXSlcbiAgICAgICAgLm1hcChtaWRkbGV3YXJlID0+IG1pZGRsZXdhcmVIYW5kbGVyKG1pZGRsZXdhcmUpKTtcbiAgICAgIGNvbnN0IGhhbmRsZXIgPSByb3V0ZUhhbmRsZXIoY29udHJvbGxlciwgbWV0aG9kTmFtZSwgbWV0YS5wYXJhbXNbbWV0aG9kTmFtZV0sIG1ldGhvZE1ldGEuc3RhdHVzKTtcblxuICAgICAgcm91dGVyW3JvdXRlLm1ldGhvZF0uYXBwbHkocm91dGVyLCBbXG4gICAgICAgIHJvdXRlLnVybCwgLi4ucm91dGVNaWRkbGV3YXJlLCBoYW5kbGVyLFxuICAgICAgXSk7XG4gICAgfSk7XG4gIH1cblxuICAoYXBwIGFzIFJvdXRlcikudXNlKG1ldGEudXJsLCByb3V0ZXIpO1xuXG4gIHJldHVybiBhcHA7XG59XG5cbi8qKlxuICogUmV0dXJucyBmdW5jdGlvbiB0aGF0IHdpbGwgY2FsbCBvcmlnaW5hbCByb3V0ZSBoYW5kbGVyIGFuZCB3cmFwIHJldHVybiBvcHRpb25zXG4gKi9cbmZ1bmN0aW9uIHJvdXRlSGFuZGxlcihjb250cm9sbGVyOiBFeHByZXNzQ2xhc3MsIG1ldGhvZE5hbWU6IHN0cmluZywgcGFyYW1zOiBQYXJhbWV0ZXJDb25maWd1cmF0aW9uW10sIHN0YXR1czogbnVtYmVyKSB7XG4gIHJldHVybiAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICBjb25zdCBhcmdzID0gZXh0cmFjdFBhcmFtZXRlcnMocmVxLCByZXMsIG5leHQsIHBhcmFtcyk7XG4gICAgY29uc3QgcmVzdWx0ID0gY29udHJvbGxlclttZXRob2ROYW1lXS5jYWxsKGNvbnRyb2xsZXIsIC4uLmFyZ3MpO1xuXG4gICAgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIFByb21pc2UpIHtcbiAgICAgIHJlc3VsdC50aGVuKChyOiBhbnkpID0+IHtcbiAgICAgICAgaWYgKCFyZXMuaGVhZGVyc1NlbnQgJiYgdHlwZW9mIHIgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgaWYgKHN0YXR1cykge1xuICAgICAgICAgICAgcmVzLnN0YXR1cyhzdGF0dXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXMuc2VuZChyKTtcbiAgICAgICAgfVxuICAgICAgfSkuY2F0Y2gobmV4dCk7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgcmVzdWx0ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgaWYgKCFyZXMuaGVhZGVyc1NlbnQpIHtcbiAgICAgICAgaWYgKHN0YXR1cykge1xuICAgICAgICAgIHJlcy5zdGF0dXMoc3RhdHVzKTtcbiAgICAgICAgfVxuICAgICAgICByZXMuc2VuZChyZXN1bHQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG59XG5cbi8qKlxuICogRXh0cmFjdCBwYXJhbWV0ZXJzIGZvciBoYW5kbGVyc1xuICovXG5mdW5jdGlvbiBleHRyYWN0UGFyYW1ldGVycyhyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbiwgcGFyYW1zOiBQYXJhbWV0ZXJDb25maWd1cmF0aW9uW10gPSBbXSk6IGFueVtdIHtcbiAgY29uc3QgYXJncyA9IFtdO1xuXG4gIGZvciAoY29uc3QgeyBuYW1lLCBpbmRleCwgdHlwZSB9IG9mIHBhcmFtcykge1xuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLlJFU1BPTlNFOlxuICAgICAgICBhcmdzW2luZGV4XSA9IHJlcztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFBhcmFtZXRlclR5cGUuUkVRVUVTVDpcbiAgICAgICAgYXJnc1tpbmRleF0gPSBnZXRQYXJhbShyZXEsIG51bGwsIG5hbWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgUGFyYW1ldGVyVHlwZS5ORVhUOlxuICAgICAgICBhcmdzW2luZGV4XSA9IG5leHQ7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLlBBUkFNUzpcbiAgICAgICAgYXJnc1tpbmRleF0gPSBnZXRQYXJhbShyZXEsICdwYXJhbXMnLCBuYW1lKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFBhcmFtZXRlclR5cGUuUVVFUlk6XG4gICAgICAgIGFyZ3NbaW5kZXhdID0gZ2V0UGFyYW0ocmVxLCAncXVlcnknLCBuYW1lKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFBhcmFtZXRlclR5cGUuQk9EWTpcbiAgICAgICAgYXJnc1tpbmRleF0gPSBnZXRQYXJhbShyZXEsICdib2R5JywgbmFtZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLkhFQURFUlM6XG4gICAgICAgIGFyZ3NbaW5kZXhdID0gZ2V0UGFyYW0ocmVxLCAnaGVhZGVycycsIG5hbWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgUGFyYW1ldGVyVHlwZS5DT09LSUVTOlxuICAgICAgICBhcmdzW2luZGV4XSA9IGdldFBhcmFtKHJlcSwgJ2Nvb2tpZXMnLCBuYW1lKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGFyZ3M7XG59XG5cbi8qKlxuICogR2V0IGNvbnRyb2xsZXIgaW5zdGFuY2UgZnJvbSBjb250YWluZXIgb3IgaW5zdGFudGlhdGUgb25lXG4gKi9cbmZ1bmN0aW9uIGdldENvbnRyb2xsZXIoQ29udHJvbGxlcjogVHlwZSk6IFByb21pc2U8RXhwcmVzc0NsYXNzPiB8IEV4cHJlc3NDbGFzcyB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIENvbnRhaW5lci5nZXQoQ29udHJvbGxlcik7XG4gIH0gY2F0Y2gge1xuICAgIHJldHVybiBuZXcgQ29udHJvbGxlcigpO1xuICB9XG59XG5cbi8qKlxuICogR2V0IHBhcmFtZXRlciB2YWx1ZSBmcm9tIHRoZSBzb3VyY2Ugb2JqZWN0XG4gKi9cbmZ1bmN0aW9uIGdldFBhcmFtKHNvdXJjZTogYW55LCBwYXJhbVR5cGU6IHN0cmluZywgbmFtZTogc3RyaW5nKTogYW55IHtcbiAgY29uc3QgcGFyYW0gPSBzb3VyY2VbcGFyYW1UeXBlXSB8fCBzb3VyY2U7XG5cbiAgcmV0dXJuIG5hbWUgPyBwYXJhbVtuYW1lXSA6IHBhcmFtO1xufVxuXG5cblxuLyoqXG4gKiBBdHRhY2ggbWlkZGxld2FyZSB0byBjb250cm9sbGVyIG1ldGFkYXRhXG4gKiBAcGFyYW0ge2Jvb2xlYW59IHVuc2hpZnQgaWYgc2V0IHRvIGZhbHNlIGFsbCB0aGUgY3VzdG9tIGRlY29yYXRvciBtaWRkbGV3YXJlcyB3aWxsIGJlIGV4ZWN0dXRlZCBhZnRlciB0aGUgbWlkZGxld2FyZXMgYXR0YWNoZWQgdGhyb3VnaCBjb250cm9sbGVyIFxuICogXG4gKiBcbiAqIE5vdGUtIFBsZWFzZSB1c2UgY3VzdG9tIGRlY29yYXRvcnMgYmVmb3JlIGV4cHJlc3MgbWV0aG9kIGRlY29yYXRvcnMgR2V0IFBvc3QgZXRjLlxuICovXG5cbmV4cG9ydCBmdW5jdGlvbiBhdHRhY2hNaWRkbGV3YXJlKHRhcmdldCA6IGFueSxwcm9wZXJ0eSA6IHN0cmluZyxtaWRkbGV3YXJlIDogTWlkZGxld2FyZUZ1bmN0aW9uKXtcbiAgY29uc3QgbWV0YSAgOiBFeHByZXNzTWV0YSA9IGdldE1ldGEodGFyZ2V0IGFzIEV4cHJlc3NDbGFzcyk7XG4gIGlmKG1ldGEudXJsICE9PSAnJyl7XG4gICAgbWV0YS5taWRkbGV3YXJlLnVuc2hpZnQobWlkZGxld2FyZSk7XG4gIH1lbHNlIGlmKHByb3BlcnR5IGluIG1ldGEucm91dGVzKXtcbiAgICBtZXRhLnJvdXRlc1twcm9wZXJ0eV0ucm91dGVzWzBdLm1pZGRsZXdhcmUudW5zaGlmdChtaWRkbGV3YXJlKTtcbiAgfVxufSJdfQ==